/*
Deployment script for HotelAppDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "HotelAppDB"
:setvar DefaultFilePrefix "HotelAppDB"
:setvar DefaultDataPath "C:\Users\crist\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\crist\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating Procedure [dbo].[spBookings_CheckIn]...';


GO
CREATE PROCEDURE [dbo].[spBookings_CheckIn]
	@Id int

AS
begin
	set nocount on;
	 update dbo.Bookings
	 set CheckedIn=1
	 where Id=@Id;
end
GO
PRINT N'Creating Procedure [dbo].[spBookings_insert]...';


GO
CREATE PROCEDURE [dbo].[spBookings_insert]
	@roomId int,
	@guestId int,
	@startDate date,
	@endDate date,
	@totalCost money
AS
begin
	set nocount on;

	insert into dbo.Bookings(RoomId,GuestId,StartDate,EndDate,TotalCost)
	values (@roomId,@guestId,@startDate,@endDate,@totalCost);
end
GO
PRINT N'Creating Procedure [dbo].[spBookings_Search]...';


GO
CREATE PROCEDURE [dbo].[spBookings_Search]
	@lastName nvarchar(50),
	@startDate date
AS
begin
	set nocount on;

	select [b].[Id], [b].[StartDate], [b].[EndDate], [b].[TotalCost], [b].[CheckedIn], [b].[GuestId], [b].[RoomId],
		   
		   [g].[FirstName], [g].[LastName],
		   [r].[RoomNumber], [r].[RoomTypeId],
		   [rt].[Title], [rt].[Description], [rt].[Price]
	from dbo.Bookings b
	inner join dbo.Guests g on b.GuestId = g.Id
	inner join dbo.Rooms r on b.RoomId = r.Id
	inner join dbo.RoomTypes rt on r.RoomTypeId=rt.Id
	where b.StartDate=@startDate and g.LastName=@lastName;
end
GO
PRINT N'Creating Procedure [dbo].[spGuests_Insert]...';


GO
CREATE PROCEDURE [dbo].[spGuests_Insert]
	@firstName nvarchar(50),
	@lastName nvarchar(50)
AS
begin
	set nocount on;

	if not exists (select 1 from dbo.Guests where FirstName =@firstName and LastName=@lastName)
	begin 
		insert into dbo.Guests(FirstName, LastName)
		values (@firstName, @lastName);
	end

	select top 1 [Id], [FirstName], [LastName]
	from dbo.Guests
	where FirstName =@firstName and LastName=@lastName;
end
GO
PRINT N'Creating Procedure [dbo].[spRooms_GetAvailableRooms]...';


GO
CREATE PROCEDURE [dbo].[spRooms_GetAvailableRooms]
	@startDate date,
	@endDate date,
	@roomTypeId int
AS
begin 
	set nocount on;
	
	select r.*
	from dbo.Rooms r
	inner join dbo.RoomTypes t on t.id=r.RoomTypeId
	where r.RoomTypeId=@roomTypeId 
	and r.Id not in(
	select b.RoomId
	from dbo.Bookings b
	where (@startDate <b.StartDate and @endDate >b.EndDate) 
		or (b.StartDate<=@endDate and @endDate<b.EndDate)
		or (b.StartDate<=@startDate and @startDate<b.EndDate)
	);
end
GO
PRINT N'Update complete.';


GO
